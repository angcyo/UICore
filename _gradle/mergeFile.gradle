/**
 * 2023-2-7
 * 将多个路径的文件内容合并到一个文件
 * */

task _mergeFile(group: 'angcyo', description: '将多个路径的文件内容合并到一个文件') {
    //配置任务
}

_mergeFile.doFirst {
    def outputPathZh = file(".apk/LaserPecker Android Resource(中文).xml").absolutePath
    def outputPathEn = file(".apk/LaserPecker Android Resource(英文).xml").absolutePath
    _mergeLanguageFile("", outputPathEn)//默认英文
    _mergeLanguageFile("-zh", outputPathZh)//中文
}

/**合并指定语言的xml文件*/
def _mergeLanguageFile(language, outputPath) {
    def pathList = []
    pathList += "./UICore/core/src/main/res/values${language}/core_strings.xml"
    pathList += "./UICore/crop/src/main/res/values${language}/crop_strings.xml"
    pathList += "./UICore/dialog/src/main/res/values${language}/dialog_strings.xml"
    pathList += "./UICore/doodle/src/main/res/values${language}/doodle_strings.xml"
    //pathList += "./UICore/canvas/src/main/res/values${language}/canvas_strings.xml"
    pathList += "./UICore/widget/src/main/res/values${language}/widget_strings.xml"

    //pathList += "./UICoreEx/canvas_lp/src/main/res/values${language}/canvas_strings.xml"
    pathList += "./UICoreEx/canvas2_lp/src/main/res/values${language}/canvas_strings.xml"
    //pathList += "./UICoreEx/engrave/src/main/res/values${language}/engrave_strings.xml"
    pathList += "./UICoreEx/engrave2/src/main/res/values${language}/engrave_strings.xml"
    pathList += "./UICoreEx/fsc/src/main/res/values${language}/fsc_strings.xml"
    pathList += "./UICoreEx/lpDevice/src/main/res/values${language}/device_strings.xml"

    _mergeFile(pathList, outputPath)
}

/** 合并文件内容到一个文件*/
def _mergeFile(pathList, outputPath) {
    def outputFile = file(outputPath)
    if (pathList != null && pathList.size() > 0) {
        outputFile.delete()
        def index = 0
        def size = pathList.size()
        for (path in pathList) {
            def pathFile = file(path)
            if (pathFile.exists()) {
                if (index > 0) {
                    outputFile.append("\n")
                }
                //outputFile.append(pathFile.text)
                def lines = pathFile.text.readLines()
                def fromIndex = 0
                def toIndex = lines.size()

                if (size > 1) {
                    if (index == 0) {
                        //如果是第一个文件, 则删除xml中的最后1行
                        toIndex = toIndex - 1
                    } else if (index == size - 1) {
                        //最后一个文件, 则删除xml中的前2行
                        fromIndex = 2
                    } else {
                        //中间行, 删除前2行, 删除最后1行
                        toIndex = toIndex - 1
                        fromIndex = 2
                    }
                }
                outputFile.append(lines.subList(fromIndex, toIndex).join("\n"))
                index++
            }
        }
        System.err.println "合并完成:${pathList}↓\n${outputPath}"
    }
}
