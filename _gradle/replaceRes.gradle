/**
 * 2023-3-24
 * 替换xml文件中的字符串资源
 * */

task _replaceRes(group: 'angcyo', description: '替换xml文件中的字符串资源') {
    //配置任务
}

_replaceRes.doFirst {
    def csvPath = file("res.csv").absolutePath
    _replaceLanguageFile("-ko", _readCsvMap(csvPath))
}

def _getLanguageResPath(language) {
    def pathList = []
    pathList += "./UICore/core/src/main/res/values${language}/core_strings.xml"
    pathList += "./UICore/crop/src/main/res/values${language}/crop_strings.xml"
    pathList += "./UICore/dialog/src/main/res/values${language}/dialog_strings.xml"
    pathList += "./UICore/doodle/src/main/res/values${language}/doodle_strings.xml"
    //pathList += "./UICore/canvas/src/main/res/values${language}/canvas_strings.xml"
    pathList += "./UICore/widget/src/main/res/values${language}/widget_strings.xml"

    //pathList += "./UICoreEx/canvas_lp/src/main/res/values${language}/canvas_strings.xml"
    pathList += "./UICoreEx/canvas2_lp/src/main/res/values${language}/canvas_strings.xml"
    //pathList += "./UICoreEx/engrave/src/main/res/values${language}/engrave_strings.xml"
    pathList += "./UICoreEx/engrave2/src/main/res/values${language}/engrave_strings.xml"
    pathList += "./UICoreEx/fsc/src/main/res/values${language}/fsc_strings.xml"
    pathList += "./UICoreEx/lpDevice/src/main/res/values${language}/device_strings.xml"
    pathList += "./UICoreEx/lpDevice/src/main/res/values${language}/material_strings.xml"

    return pathList
}

/**合并指定语言的xml文件*/
def _replaceLanguageFile(outLanguage, map) {
    _replaceResList(_getLanguageResPath("-zh"), _getLanguageResPath(outLanguage), map)
}

/**读取csv文件, 返回对应的map*/
def _readCsvMap(path) {
    def pathFile = file(path)
    def lines = pathFile.text.readLines()
    def result = [:]
    lines.forEach { line ->
        def lineList = line.split(",")
        if (lineList.size() >= 2) {
            result[lineList[0]] = lineList[1]
        }
    }
    return result
}

def _replaceResList(pathList, outPathList, map) {
    pathList.eachWithIndex { path, index ->
        _replaceRes(path, outPathList[index], map)
    }
}

/**替换资源
 * [path] 需要替换的文件路径
 * [outPath] 替换后的输出文件路径
 * [map] 需要替换的键值对映射表
 * */
def _replaceRes(path, outPath, map) {
    def pathFile = file(path)
    if (!pathFile.exists()) {
        return
    }
    def originText = pathFile.text //原始文件内容
    def count = 0
    map.each { key, val ->
        if (key != null && !key.isEmpty()) {
            def resKey = ">${key}<"
            if (originText.contains(resKey)) {
                originText = originText.replaceAll(resKey, ">${val}<")//替换资源
                count++
            }
        }
    }
    def outPathFile = file(outPath)
    if (!outPathFile.exists()) {
        outPathFile.parentFile.mkdirs()
        outPathFile.createNewFile()
    }
    outPathFile.write(originText)//重写文件
    System.err.println "替换完成:${pathFile.absolutePath}↓\n->${outPathFile.absolutePath} 共:${count}"
}
